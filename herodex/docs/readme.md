## **项目设计文档：小侠成长录 (Herodex)**

### **1. 项目概述**

*   **项目名称**: 小侠成长录 (英文名: Herodex)
*   **核心目标**: 开发一个游戏化的学习激励与记录系统。通过将小学生的日常学习任务（如作业、日记）转化为富有武侠/修仙趣味的“功课呈报”和“技能修炼”过程，激发孩子的学习兴趣，并为家长提供一个高效、有趣的激励工具。
*   **项目主题**: 武侠修仙、技能树、等级成长、AI辅助。
*   **目标用户**:
    *   **管理员 (家长)**: 系统的配置者和“掌门”。负责审核孩子的“功课”，并在AI辅助下进行“嘉奖”（加点），同时管理整个“武学体系”（技能库）。
    *   **玩家 (孩子/小侠)**: 系统的主要使用者。负责每日“修炼”（学习），并向“师傅”呈报功课，通过查看自己的“角色面板”和“技能树”获得成就感。

### **2. 核心概念**

*   **技能 (Skill)**: 代表一个具体的知识点（如“四则混合运算”）。每个技能都包含一个**游戏化名称**（如“乾坤四象斩”）和一个**真实名称**，便于家长和孩子理解。
*   **技能树 (Skill Tree)**: 由所有技能及其依赖关系构成的网络。掌握前置技能是解锁后续高级技能的“修行”路径。
*   **熟练度 (Proficiency)**: 针对**单个技能**的数值，代表孩子对该知识点的掌握程度。
*   **技能等级 (Skill Level)**: 由“熟练度”累积转化而来的等级（如：初窥门径 Lv1 -> 登峰造极 Lv5）。
*   **修为点 (XP)**: 代表玩家的**总体经验值**，是衡量孩子总体努力程度的宏观指标。
*   **功课呈报 (Daily Submission)**: 孩子每日向系统（“师傅”）提交学习成果的核心行为。内容可包括“修炼心得”（日记）和“修炼成果”（作业的图片、语音、视频等附件）。
*   **角色面板 (Player Dashboard)**: **[孩子视角]** 展示玩家当前状态的界面，包括总修为、各科属性、称号等。
*   **管理后台 (Admin Panel)**: **[家长视角]** 用于管理整个系统的界面。

### **3. 核心工作流程：AI辅助的“每日评阅”**

这是系统最具特色的核心流程，驱动所有的数据变化。

1.  **[孩子] 呈报功课**:
    *   孩子在自己的界面进入“功课呈报”区。
    *   **可选地**写入一段“修炼心得”（日记）。
    *   上传**一份或多份**“修炼成果”附件（图片、语音、视频）。
    *   点击“**呈报师傅**”按钮，提交后，该条记录状态为 `待审核`。

2.  **[家长] 请求AI评定**:
    *   家长在管理后台看到一条待审核的功课呈报。
    *   查看孩子提交的内容后，点击“**请师傅评定**”。
    *   系统将孩子提交的**日记文本、所有附件的URL、以及系统内完整的技能清单**发送给AI模型（如ollama、豆包、kimi、chatglm等）。

3.  **[AI] 分析并返回建议**:
    *   AI（扮演“师傅”角色）分析收到的所有材料，识别其中涉及的知识点，并评估完成质量。
    *   AI返回一段结构化的JSON数据，包含：
        *   `comment`: 一段以“师傅”口吻写的鼓励性**评语**。
        *   `suggested_xp`: 建议奖励的**修为点**。
        *   `suggested_proficiency`: 一个数组，包含建议增加**熟练度**的技能及其点数 `[{skill_id: '...', points: 10}, ...]`。

4.  **[家长] 审核与调整**:
    *   家长界面上会自动填入AI的建议。
    *   家长可以预览“师傅评语”，并对AI建议的修为点和各技能熟练度点数进行**微调或完全修改**。

5.  **[家长] 确认授予**:
    *   家长点击“**确认授予**”按钮。
    *   系统将**最终确认**的数据写入`hdx_activity_log`表，并触发后台的升级和解锁逻辑。
    *   该条“功课呈报”的状态更新为 `已完成`。

6.  **[孩子] 收到反馈**:
    *   孩子在自己的界面收到通知，可以查看“师傅”的最终评语和本次修炼获得的全部奖励，完成激励闭环。

### **4. 用户角色与功能需求**

#### **4.1 家长 (管理员)**

*   **US-A1: 登录认证**: 作为家长，我想要安全地登录管理后台，以便于管理整个系统。
*   **US-A2: 评阅功课**: 作为家长，我想要审核孩子提交的每日功课，通过AI获取评定建议，并在调整后最终确认奖励，以便于高效、公正地激励孩子。
*   **US-A3: 查看总览**: 作为家长，我想要看到一个数据总览页面，快速了解孩子的总体修为、各科进度和最近的活动记录。
*   **US-A4: 技能库管理**: 作为家长，我想要能够增、删、改、查系统中的所有技能，以便于让技能树与孩子的学习大纲保持同步。
*   **US-A5: 技能依赖管理**: 作为家长，我想要能够定义和修改技能之间的前置依赖关系，以便于构建一个逻辑合理的技能树。

#### **4.2 孩子 (玩家)**

*   **US-C1: 呈报每日功课**: 作为小侠，我想要通过写心得和上传附件的方式向“师傅”汇报我当天的修炼成果，以便于获得一种沉浸式的角色扮演体验。
*   **US-C2: 接收师傅反馈**: 作为小侠，我想要在功课被评阅后，看到“师傅”给我的专属评语和奖励，以便于感受到我的努力被认可。
*   **US-C3: 查看角色面板**: 作为小侠，我想要看到我的角色面板，包含我的侠名、总修为和各科属性，以便于直观地感受我的成长。
*   **US-C4: 浏览技能树**: 作为小侠，我想要以可视化的方式浏览我的技能树，清楚地看到哪些武功已掌握，哪些正在修炼，还有哪些待解锁，以便于获得持续的升级动力。

### **5. 界面设计草案**

#### **5.1 管理后台 (Admin Panel)**

*   **风格**: 简洁、功能驱动、数据清晰。
*   **核心页面**:
    1.  **仪表盘**: 显示待办事项（如“N条功课待评阅”）、核心数据卡片、近期活动图表。
    2.  **功课评阅**: 核心操作页面。采用双栏布局，左侧展示孩子提交的日记和附件，右侧为AI评定和家长调整的区域。
    3.  **技能管理**: 支持增删改查的数据表格。
    4.  **依赖管理**: 用于配置技能树关系的可视化或表格式界面。

#### **5.2 孩子端界面 (Player View)**

*   **风格**: 游戏化、武侠/国风主题、视觉丰富、交互友好。
*   **核心模块**:
    1.  **功课呈报**: 一个独立的页面或弹窗，包含日记文本框、多文件上传器和“呈报师傅”按钮。下方有历史呈报记录及状态。
    2.  **角色面板**: 页面顶部或侧边的常驻信息栏，展示角色核心信息。
    3.  **技能树**: 页面的主区域，一个可缩放、拖拽的可视化技能网络。技能节点有不同状态（锁定、解锁、精通），点击可查看详情（游戏化描述、熟练度进度条）。

### **6. 数据库设计**

数据库结构已通过独立的SQL文件详细定义。核心表包括：`hdx_players`, `hdx_skills`, `hdx_player_skills`, `hdx_skill_dependencies`, `hdx_activity_log` 以及为每日汇报流程设计的 `hdx_daily_submissions` 和 `hdx_submission_attachments`。
详细数据库设计请参考[数据库文档](supabase/init.sql)。

### **7. 技术栈**

* 本模块作为插件框架的一个插件，请参考插件框架的技术栈。
* 所有实现代码，均放在src/plugins/herodex目录下。
